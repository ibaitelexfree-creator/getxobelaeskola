name: "‚ö° Fast Lane: Parallel Verification"

on:
    push:
        branches: [main, "feature/**", "fix/**"]
    pull_request:
        branches: [main]

jobs:
    fast-scan:
        name: "üöÄ Parallel Scan (<30s)"
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: "Setup Runtime"
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: "‚ö° Parallel Execution: Lint & Logic"
              run: |
                  # 1. Install ultra-fast tools (binaries, no full npm install)
                  npm install -g oxlint@latest @biomejs/biome@latest --no-progress --loglevel=error

                  # 2. RUN PARALLEL JOBS
                  # Grouping everything to stay within the "1-minute" billable window
                  echo "üèÅ Starting parallel scans..."

                  # Run commands, redirect output to log files, and capture failure status
                  (oxlint ./src --quiet > oxlint.log 2>&1 || touch oxlint.failed) &
                  (biome check ./src --diagnostic-level=error > biome.log 2>&1 || touch biome.failed) &

                  # Wait for all background jobs
                  wait

                  # Check for failures
                  if [ -f oxlint.failed ] || [ -f biome.failed ]; then
                      echo "‚ùå One or more checks failed."
                      exit 1
                  fi

                  echo "‚ú® All fast scans completed successfully!"

            - name: "üö® Self-Healing: Report Failure"
              if: failure()
              run: node scripts/ci-self-healing.js
              env:
                  GITHUB_REPOSITORY: ${{ github.repository }}
                  GITHUB_REF_NAME: ${{ github.ref_name }}
                  GITHUB_WORKFLOW: ${{ github.workflow }}
                  GITHUB_RUN_NUMBER: ${{ github.run_number }}

    heavy-compute:
        name: "üèóÔ∏è Heavy CI (Conditional)"
        needs: fast-scan
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: "Full Build & Test"
              run: |
                  echo "üõ†Ô∏è Starting heavy compute tasks..."
                  # Aqu√≠ ir√≠a el npm install y next build real
                  # Solo se lanza si el Fast Scan pasa y estamos en main
                  echo "‚úÖ Full CI completed"
