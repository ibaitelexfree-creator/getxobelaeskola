name: "üîß Auto-Fix CI Errors"

on:
    workflow_run:
        workflows: ["‚öì CI Pipeline"]
        types:
            - completed

jobs:
    auto-fix:
        runs-on: ubuntu-latest
        if: >-
            github.event.workflow_run.conclusion == 'failure' &&
            startsWith(github.event.workflow_run.head_branch, 'jules/')

        steps:
            - name: "üìã Get Failed Run Logs"
              id: logs
              uses: actions/github-script@v7
              with:
                  script: |
                      const run_id = context.payload.workflow_run.id;
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;
                      const branch = context.payload.workflow_run.head_branch;

                      const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                        owner, repo, run_id
                      });

                      const failedJob = jobs.jobs.find(j => j.conclusion === 'failure');
                      if (!failedJob) {
                        core.setOutput('should_fix', 'false');
                        return;
                      }

                      const { data: logData } = await github.rest.actions.downloadJobLogsForWorkflowRun({
                        owner, repo, job_id: failedJob.id
                      });

                      const { data: commits } = await github.rest.repos.listCommits({
                        owner, repo, sha: branch, per_page: 10
                      });

                      const fixAttempts = commits.filter(c =>
                        c.commit.message.includes('CI auto-fix')
                      ).length;

                      if (fixAttempts >= 3) {
                        core.setOutput('should_fix', 'false');
                        core.setOutput('max_attempts', 'true');
                      } else {
                        core.setOutput('should_fix', 'true');
                        core.setOutput('attempt', String(fixAttempts + 1));
                        core.setOutput('branch', branch);
                        core.setOutput('error_log', logData.substring(0, 3000));
                      }

            - name: "üîî Notify Max Attempts Reached"
              if: steps.logs.outputs.max_attempts == 'true'
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_CHAT_ID }}
                  token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
                  message: |
                      ‚ùå *Auto-Fix AGOTADO* (3/3 intentos)

                      Rama: `${{ github.event.workflow_run.head_branch }}`
                      Se necesita intervenci√≥n humana.

                      üîó [Ver CI](${{ github.event.workflow_run.html_url }})

            - name: "üöÄ Trigger Jules Fixer via n8n"
              if: steps.logs.outputs.should_fix == 'true'
              run: |
                  curl -X POST "${{ secrets.N8N_WEBHOOK_URL }}/webhook/jules-auto-fix" \
                    -H "Content-Type: application/json" \
                    -d '{
                      "branch": "${{ steps.logs.outputs.branch }}",
                      "attempt": "${{ steps.logs.outputs.attempt }}",
                      "error_log": ${{ toJSON(steps.logs.outputs.error_log) }},
                      "repository": "${{ github.repository }}",
                      "run_url": "${{ github.event.workflow_run.html_url }}"
                    }'

            - name: "üîî Notify Auto-Fix Triggered"
              if: steps.logs.outputs.should_fix == 'true'
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_CHAT_ID }}
                  token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
                  message: |
                      üîß *Auto-Fix Attempt #${{ steps.logs.outputs.attempt }}*

                      Rama: `${{ steps.logs.outputs.branch }}`
                      Jules Fixer est√° trabajando en la correcci√≥n...

                      üîó [Ver Error](${{ github.event.workflow_run.html_url }})
