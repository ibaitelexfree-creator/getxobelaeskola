name: "ðŸš€ Bitbucket Dispatch Receiver"

# Triggered by Bitbucket pipeline via repository_dispatch
on:
  repository_dispatch:
    types: [bitbucket-signal]

env:
  NODE_VERSION: "22"
  JAVA_VERSION: "21"
  BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Web Lint + Build (Next.js)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  web-ci:
    name: "ðŸŒ Web CI"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“‹ Log dispatch payload"
        run: |
          echo "ðŸ”” Dispatch from Bitbucket"
          echo "Commit: ${{ github.event.client_payload.commit }}"
          echo "Branch: ${{ github.event.client_payload.branch }}"
          echo "Task: ${{ github.event.client_payload.task }}"
          echo "Time: ${{ github.event.client_payload.timestamp }}"

      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || 'main' }}

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: "ðŸ“¦ Install dependencies"
        run: npm ci --legacy-peer-deps

      - name: "ðŸ” Oxlint (Rust linter)"
        run: npx oxlint ./src --quiet

      - name: "ðŸ§  SBRM Health Check (Browserless)"
        run: node .agent/sbrm/router.js health

      - name: "ðŸ—ï¸ Build Next.js"
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CALENDAR_ID: ${{ secrets.GOOGLE_CALENDAR_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Android Build (Capacitor + Gradle)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android-ci:
    name: "ðŸ“± Android CI"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“‹ Log dispatch payload"
        run: |
          echo "ðŸ”” Android build triggered by Bitbucket dispatch"
          echo "Commit: ${{ github.event.client_payload.commit }}"

      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || 'main' }}

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: "ðŸ“¦ Install dependencies"
        run: npm ci --legacy-peer-deps

      - name: "ðŸ—ï¸ Build Capacitor static export"
        run: npm run build:capacitor
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CALENDAR_ID: ${{ secrets.GOOGLE_CALENDAR_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          IS_CAPACITOR: "true"

      - name: "â˜• Setup Java"
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: "ðŸ“± Setup Android SDK"
        uses: android-actions/setup-android@v3

      - name: "âš¡ Nitro Lint (Android)"
        run: bash scripts/mobile/lint-nitro.sh || echo "âš ï¸ Lint warnings detected"

      - name: "ðŸ”— Capacitor Sync"
        run: npx cap sync android

      - name: "ðŸ”¨ Build Android APK (Debug)"
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon

      - name: "âœ… Verify APK"
        run: ls -l android/app/build/outputs/apk/debug/app-debug.apk

      - name: "ðŸ“¤ Upload APK artifact"
        uses: actions/upload-artifact@v6
        with:
          name: app-debug-${{ github.event.client_payload.commit }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Notify completion
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: "ðŸ“Š Report"
    runs-on: ubuntu-latest
    needs: [web-ci, android-ci]
    if: always()
    steps:
      - name: "ðŸ“Š CI Summary"
        run: |
          echo "## ðŸš€ Bitbucket Dispatch CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web CI | ${{ needs.web-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android CI | ${{ needs.android-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.event.client_payload.commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.event.client_payload.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered:** ${{ github.event.client_payload.timestamp }}" >> $GITHUB_STEP_SUMMARY
