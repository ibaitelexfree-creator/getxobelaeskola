services:
  # 1. Main App (Getxo Sailing School)
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
        STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
        GOOGLE_CALENDAR_ID: ${GOOGLE_CALENDAR_ID}
        GOOGLE_SERVICE_ACCOUNT_EMAIL: ${GOOGLE_SERVICE_ACCOUNT_EMAIL}
        GOOGLE_PRIVATE_KEY: ${GOOGLE_PRIVATE_KEY}
        STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
        RESEND_API_KEY: ${RESEND_API_KEY}
    image: ${DOCKER_IMAGE:-getxo-web:latest}
    container_name: getxo-web
    restart: always
    expose:
      - "3000"
    labels:
      - "traefik.enable=true"
      # Global HTTP to HTTPS redirect middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      
      # HTTP Router (Permanent Redirect)
      - "traefik.http.routers.getxo-http.rule=Host(`getxobelaeskola.cloud`) || Host(`www.getxobelaeskola.cloud`)"
      - "traefik.http.routers.getxo-http.entrypoints=web"
      - "traefik.http.routers.getxo-http.middlewares=redirect-to-https"
      
      # HTTPS Router
      - "traefik.http.routers.getxo.rule=Host(`getxobelaeskola.cloud`) || Host(`www.getxobelaeskola.cloud`)"
      - "traefik.http.routers.getxo.entrypoints=websecure"
      - "traefik.http.routers.getxo.tls.certresolver=mytlschallenge"
      - "traefik.http.services.getxo.loadbalancer.server.port=3000"
    env_file:
      - .env
    environment:
      - PORT=3000
    networks:
      - n8n_default

  # 2. Control Manager / Explorer Dashboard
  mission-control:
    build:
      context: .
      dockerfile: mission-control/Dockerfile
    image: ${MISSION_CONTROL_IMAGE:-mission-control-dashboard:latest}
    container_name: mission-control
    restart: always
    expose:
      - "3100"
    labels:
      - "traefik.enable=true"
      # HTTP Router (Redirect)
      - "traefik.http.routers.controlmanager-http.rule=Host(`controlmanager.cloud`)"
      - "traefik.http.routers.controlmanager-http.entrypoints=web"
      - "traefik.http.routers.controlmanager-http.middlewares=redirect-to-https"
      
      # HTTPS Router (Dashboard)
      - "traefik.http.routers.controlmanager.rule=Host(`controlmanager.cloud`)"
      - "traefik.http.routers.controlmanager.entrypoints=websecure"
      - "traefik.http.routers.controlmanager.tls.certresolver=mytlschallenge"
      - "traefik.http.services.controlmanager.loadbalancer.server.port=3100"
    networks:
      - n8n_default

  # 3. Orchestrator Gateway (AI Maestro)
  orchestrator:
    build:
      context: .
      dockerfile: orchestration/Dockerfile
    image: ${ORCHESTRATOR_IMAGE:-nodejs-orchestrator:latest}
    container_name: nodejs-orchestrator
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3323
      - JULES_API_KEY=${JULES_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - OPEN_WEATHER_API_KEY=${OPEN_WEATHER_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    expose:
      - "3323"
    labels:
      - "traefik.enable=true"
      # Route for /orchestrator path under the same domain
      - "traefik.http.routers.orchestrator-api.rule=Host(`controlmanager.cloud`) && PathPrefix(`/orchestrator`)"
      - "traefik.http.middlewares.orchestrator-strip.stripprefix.prefixes=/orchestrator"
      - "traefik.http.routers.orchestrator-api.entrypoints=websecure"
      - "traefik.http.routers.orchestrator-api.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.orchestrator-api.middlewares=orchestrator-strip"
      - "traefik.http.services.orchestrator-api.loadbalancer.server.port=3323"
    networks:
      - n8n_default

networks:
  n8n_default:
    external: true
