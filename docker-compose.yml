services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
        STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
        GOOGLE_CALENDAR_ID: ${GOOGLE_CALENDAR_ID}
        GOOGLE_SERVICE_ACCOUNT_EMAIL: ${GOOGLE_SERVICE_ACCOUNT_EMAIL}
        GOOGLE_PRIVATE_KEY: ${GOOGLE_PRIVATE_KEY}
        STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
        RESEND_API_KEY: ${RESEND_API_KEY}
    image: ${DOCKER_IMAGE:-getxo-web:latest}
    container_name: getxo-web
    restart: always
    expose:
      - "3000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.getxo.rule=Host(`getxobelaeskola.cloud`) || Host(`www.getxobelaeskola.cloud`)"
      - "traefik.http.routers.getxo.entrypoints=websecure"
      - "traefik.http.routers.getxo.tls.certresolver=mytlschallenge"
      - "traefik.http.services.getxo.loadbalancer.server.port=3000"
      # HTTPS Redirect
      - "traefik.http.routers.getxo-http.rule=Host(`getxobelaeskola.cloud`) || Host(`www.getxobelaeskola.cloud`)"
      - "traefik.http.routers.getxo-http.entrypoints=web"
      - "traefik.http.routers.getxo-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    env_file:
      - .env
    networks:
      - n8n_default

  mission-control:
    build:
      context: .
      dockerfile: mission-control/Dockerfile
    image: ${MISSION_CONTROL_IMAGE:-mission-control-dashboard:latest}
    container_name: mission-control
    restart: always
    expose:
      - "3100"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.controlmanager.rule=Host(`controlmanager.cloud`)"
      - "traefik.http.routers.controlmanager.entrypoints=websecure"
      - "traefik.http.routers.controlmanager.tls.certresolver=mytlschallenge"
      - "traefik.http.services.controlmanager.loadbalancer.server.port=3100"
      # HTTPS Redirect
      - "traefik.http.routers.controlmanager-http.rule=Host(`controlmanager.cloud`)"
      - "traefik.http.routers.controlmanager-http.entrypoints=web"
      - "traefik.http.routers.controlmanager-http.middlewares=redirect-to-https"
    env_file:
      - .env
    networks:
      - n8n_default
    depends_on:
      - orchestrator

  orchestrator:
    build:
      context: .
      dockerfile: orchestration/Dockerfile
    image: ${ORCHESTRATOR_IMAGE:-jules-orchestrator-gateway:latest}
    container_name: orchestrator-gateway
    restart: always
    expose:
      - "3323"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.orchestrator.rule=Host(`controlmanager.cloud`) && PathPrefix(`/api`)"
      - "traefik.http.routers.orchestrator.entrypoints=websecure"
      - "traefik.http.routers.orchestrator.tls.certresolver=mytlschallenge"
      - "traefik.http.services.orchestrator.loadbalancer.server.port=3323"
    env_file:
      - .env
      - orchestration/.env
    networks:
      - n8n_default

networks:
  n8n_default:
    external: true
