(function(){try{var e=typeof window<`u`?window:typeof global<`u`?global:typeof globalThis<`u`?globalThis:typeof self<`u`?self:{};e.SENTRY_RELEASE={id:`n8n@2.9.4`}}catch{}})();try{(function(){var e=typeof window<`u`?window:typeof global<`u`?global:typeof globalThis<`u`?globalThis:typeof self<`u`?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]=`cfde6f70-af9b-4e1f-93fc-12abdbf0f8ea`,e._sentryDebugIdIdentifier=`sentry-dbid-cfde6f70-af9b-4e1f-93fc-12abdbf0f8ea`)})()}catch{}import{C as e,Cn as t,D as n,Gt as r,It as i,L as a,P as o,_t as s,et as c,j as l,w as u}from"./vue.runtime.esm-bundler-1e_FtHOF.js";import{yt as ee}from"./_MapCache-DjbOQyB7.js";import{Ci as te,_t as d}from"./src-CppJvwzX.js";import{Bt as ne,Lt as re,Ua as f,Wc as p,it as m,jr as ie,ot as ae,r as oe,rt as se,s as ce,st as le,t as ue,ur as de,ws as fe,xa as h,yr as pe,zr as me}from"./users.store-pCkD7Zo0.js";import{Ha as he,ts as g}from"./constants-D1jZwsUK.js";import{j as _,r as ge,v}from"./_baseOrderBy-El3qbNHQ.js";const y=d();var b=[`data-action-parameter-node`],_e=o({__name:`AiUpdatedCodeMessage`,props:{nodeName:{}},setup(e){let i=ee();return(a,o)=>(c(),n(`div`,null,[l(t(r(i).baseText(`aiAssistant.codeUpdated.message.body1`))+` `,1),u(`a`,{"data-action":`openNodeDetail`,"data-action-parameter-node":e.nodeName},t(e.nodeName),9,b),l(` `+t(r(i).baseText(`aiAssistant.codeUpdated.message.body2`)),1)]))}}),ve=[`code-diff`,`text`,`block`];const x=_(p.ASSISTANT,()=>{let t=fe(),n=ge(),r=ie(),o=i([]),c=ue(),l=oe(),u=ce(),d=te(),f=i(),p=ne(),_=ee(),b=re(),x=le(),S=i({}),C=i(),w=i(),T=i(),E=i(void 0),D=i(),O=i(),k=i(`not_executed`),A=i(),j=i(),M=i(!0),N=i(!0),P=e(()=>o.value.filter(e=>e.role===`assistant`)),F=e(()=>o.value.filter(e=>e.role===`user`)),I=e(()=>{let e=P.value[P.value.length-1],t=e?.type===`event`&&e?.eventName===`end-session`;return T.value===void 0||t}),L=e(()=>t.isAiAssistantEnabled),R=e(()=>g.includes(d.name)&&!u.activeNode()),ye=e(()=>o.value.filter(e=>ve.includes(e.type)&&e.role===`assistant`&&!e.read).length),be=e(()=>!r.isOpen&&!R.value&&L.value&&g.includes(d.name)),xe=e(()=>de([`rbac`],{rbac:{scope:`aiAssistant:manage`}})),z=e(()=>t.settings.ai.allowSendingParameterValues);function B(){Ce(),T.value=void 0,w.value=void 0,O.value=void 0,E.value=void 0,S.value={},k.value=`not_executed`,C.value=void 0,j.value=void 0,D.value=u.workflowId}function V(e,t){let n=r.isOpen&&r.activeMode===`assistant`,i=[...o.value].filter(e=>!(e.id===t&&e.role===`assistant`));A.value=void 0,(e??[]).forEach(e=>{e.type===`message`?i.push({id:t,type:`text`,role:`assistant`,content:e.text,quickReplies:e.quickReplies,codeSnippet:e.codeSnippet,read:n}):e.type===`code-diff`?i.push({id:t,role:`assistant`,type:`code-diff`,description:e.description,codeDiff:e.codeDiff,suggestionId:e.suggestionId,quickReplies:e.quickReplies,read:n}):e.type===`summary`?i.push({id:t,type:`block`,role:`assistant`,title:e.title,content:e.content,quickReplies:e.quickReplies,read:n}):e.type===`event`?i.push({id:t,type:`event`,role:`assistant`,eventName:e.eventName,read:!0}):e.type===`agent-suggestion`?i.push({id:t,type:`block`,role:`assistant`,title:e.title,content:e.text,quickReplies:e.quickReplies,read:n}):e.type===`intermediate-step`&&(A.value=e.text)}),o.value=i}function H(e){let t=e.node.name;return j.value===`error`&&u.activeExecutionId===E.value&&t===w.value?.node.name}function Se(e){return j.value===`credentials`&&e.name===C.value?.name}function Ce(){o.value=[]}function U(){f.value=!1}function we(e,t,n){o.value.push({id:t,role:`assistant`,type:`error`,content:e,read:!0,retry:n})}function W(e){A.value=e}function G(e,t){o.value.push({id:t,role:`user`,type:`text`,content:e,read:!0})}function K(e,t,n){v(e instanceof Error),U(),A.value=void 0,we(_.baseText(`aiAssistant.serviceError.message`,{interpolate:{message:e.message}}),t,n)}function q(e,t){if(e.sessionId&&!T.value){if(T.value=e.sessionId,b.track(`Assistant session started`,{chat_session_id:T.value,task:j.value,node_type:w.value?.node.type,credential_type:C.value?.name}),F.value.length===1&&j.value===`support`){let e=F.value[0];Ae(e.content,!1)}}else if(T.value!==e.sessionId)return;V(e.messages,t)}function J(){return`${Math.floor(Math.random()*1e8)}`}function Y(e){U(),M.value=!1,N.value=!1,O.value=o.value.find(t=>t.id===e&&!t.read&&t.role===`assistant`&&ve.includes(t.type)),setTimeout(()=>{O.value?.id===e&&(O.value=void 0)},4e3)}async function Te(e){let t=!!T.value;await X(`How do I set up the credentials for ${e.displayName}?`,e),je({source:`credential`,task:`credentials`,has_existing_session:t})}async function Ee(e){if(j.value===`error`)return{aiUsageSettings:{allowSendingParameterValues:z.value}};let t=d.name,n=u.activeNode(),r=n?await x.processNodeForAssistant(n,[`position`,`parameters.notice`],{excludeParameterValues:!z.value}):null,i=l.activeModals.includes(`editCredential`)?se().getCredentialTypeByName(l.activeCredentialType??``):void 0,a=u.workflowExecutionData?.data?.resultData,o=!!a?.runData?.hasOwnProperty(n?.name??``),s=a?.error&&`node`in a.error&&a.error.node?.name===n?.name?a.error:void 0,c=o?{status:s?`error`:`success`,error:s?x.simplifyErrorForAssistant(s):void 0}:void 0;return{aiUsageSettings:{allowSendingParameterValues:z.value},currentView:{name:t,description:x.getCurrentViewDescription(t)},activeNodeInfo:{node:r??void 0,nodeIssues:o?void 0:n?.issues,executionStatus:c,nodeInputData:e?.nodeInputData,referencedNodes:e?.schemas},activeCredentials:i?{name:i?.name,displayName:i?.displayName,authType:e?.authType?.name}:void 0,currentWorkflow:M.value?await x.simplifyWorkflowForAssistant(u.workflow,{excludeParameterValues:!z.value}):void 0,executionData:N.value&&a?x.simplifyResultData(a,{removeParameterValues:!z.value}):void 0}}async function X(e,t){B(),j.value=t?`credentials`:`support`;let r=u.activeNode(),i=x.getNodeInfoForAssistant(r,{excludeParameterValues:!z.value}),a=j.value===`support`?await Ee(i):{aiUsageSettings:{allowSendingParameterValues:z.value}};i.authType&&j.value===`credentials`&&(e+=` I am using ${i.authType.name}.`);let o=J();C.value=t,G(e,o),W(_.baseText(`aiAssistant.thinkingSteps.thinking`)),f.value=!0;let s={role:`user`,type:`init-support-chat`,user:{firstName:c.currentUser?.firstName??``},context:a,question:e};t&&(s={...s,type:`init-cred-help`,credentialType:{name:t.name,displayName:t.displayName}}),m(n.restApiContext,{payload:s},e=>q(e,o),()=>Y(o),n=>K(n,o,async()=>await X(e,t)))}async function De(e){let t=J();if(w.value&&H(e))return;B(),j.value=`error`,w.value=e,D.value=u.workflowId,u.activeExecutionId&&(E.value=u.activeExecutionId);let{authType:r,nodeInputData:i,schemas:a}=x.getNodeInfoForAssistant(e.node,{excludeParameterValues:!z.value});W(_.baseText(`aiAssistant.thinkingSteps.analyzingError`)),f.value=!0;let o={role:`user`,type:`init-error-helper`,user:{firstName:c.currentUser?.firstName??``},error:e.error,node:await x.processNodeForAssistant(e.node,[`position`,`parameters.notice`],{excludeParameterValues:!z.value}),nodeInputData:i,executionSchema:a,authType:r,context:{aiUsageSettings:{allowSendingParameterValues:z.value}}};m(n.restApiContext,{payload:o},e=>q(e,t),()=>Y(t),n=>K(n,t,async()=>await De(e)))}async function Z(e,t){if(I.value||f.value)return;v(T.value);let r=J();W(_.baseText(`aiAssistant.thinkingSteps.thinking`)),f.value=!0,m(n.restApiContext,{payload:{role:`user`,type:`event`,eventName:e,error:t},sessionId:T.value},e=>q(e,r),()=>Y(r),n=>K(n,r,async()=>await Z(e,t)))}async function Oe(e){!w.value||e.nodeName!==w.value.node.name||k.value!==`success`&&(e.data.error&&k.value!==`error`?(await Z(`node-execution-errored`,e.data.error),k.value=`error`,b.track(`User executed node after assistant suggestion`,{task:j.value,chat_session_id:T.value,success:!1})):e.data.executionStatus===`success`&&[`error`,`not_executed`].includes(k.value)&&(await Z(`node-execution-succeeded`),k.value=`success`,b.track(`User executed node after assistant suggestion`,{task:j.value,chat_session_id:T.value,success:!0})))}async function ke(e){if(I.value||f.value)return;let t=J(),r=async()=>{o.value=o.value.filter(e=>e.id!==t),await ke(e)};try{G(e.text,t),W(_.baseText(`aiAssistant.thinkingSteps.thinking`)),f.value=!0,v(T.value),e.quickReplyType===`new-suggestion`&&k.value!==`not_executed`&&(k.value=`not_executed`);let i=u.activeNode(),a=await Ee(x.getNodeInfoForAssistant(i,{excludeParameterValues:!z.value}));m(n.restApiContext,{payload:{id:me(),role:`user`,type:`message`,text:e.text,quickReplyType:e.quickReplyType,context:a},sessionId:T.value},e=>q(e,t),()=>Y(t),e=>K(e,t,r)),Ae(e.text,!!e.quickReplyType)}catch(e){K(e,t,r)}}function Ae(e,t){T.value&&b.track(`User sent message in Assistant`,{message:e,is_quick_reply:t,chat_session_id:T.value,message_number:F.value.length,task:j.value,allow_sending_parameter_values:z.value})}function je({source:e,task:t,has_existing_session:r}){let i=u.allNodes.length===0?`empty`:`existing_workflow`;b.track(`User opened assistant`,{source:e,task:t,has_existing_session:r,instance_id:n.instanceId,workflow_id:u.workflowId,canvas_status:i,node_type:w.value?.node?.type,error:w.value?.error,chat_session_id:T.value})}function Q(e,t,n){p.activeNodeName===t?Object.keys(n).forEach(e=>{let r={node:t,name:`parameters.${e}`,value:n[e]};y.emit(`updateParameterValue`,r)}):e.setNodeParameters({name:t,value:n},!0)}function Me(e,t){return t.reduce((t,n)=>(t[n]=he(e[n]),t),{})}async function Ne(e,t){let r=o.value[t];if(!r||r.type!==`code-diff`)throw Error(`No code diff to apply`);try{v(w.value),v(T.value),r.replacing=!0;let t=r.suggestionId,i=u.workflowObject.getNode(w.value.node.name);v(i);let a=S.value[t];if(a)Q(e,i.name,a.suggested);else{let{parameters:a}=await ae(n.restApiContext,{suggestionId:r.suggestionId,sessionId:T.value});S.value[t]={previous:Me(i.parameters,Object.keys(a)),suggested:a},Q(e,i.name,a)}r.replaced=!0,h.emit(`codeDiffApplied`),$(i.name)}catch(e){console.error(e),r.error=!0}r.replacing=!1}async function Pe(e,t){let n=o.value[t];if(!n||n.type!==`code-diff`)throw Error(`No code diff to apply`);try{v(w.value),v(T.value),n.replacing=!0;let t=n.suggestionId,r=S.value[t];v(r);let i=u.workflowObject.getNode(w.value.node.name);v(i);let a=r.previous;Q(e,i.name,a),n.replaced=!1,h.emit(`codeDiffApplied`),$(i.name)}catch(e){console.error(e),n.error=!0}n.replacing=!1}function $(e){e!==p.activeNodeName&&pe().showMessage({type:`success`,title:_.baseText(`aiAssistant.codeUpdated.message.title`),message:a(_e,{nodeName:e}),duration:4e3})}return s(d,()=>{let e=u.workflowId;!T.value||!D.value||D.value===e||B()}),s(()=>l.stateIsDirty,()=>{M.value=!0}),s(()=>u.workflowExecutionResultDataLastUpdate,()=>{N.value=!0},{immediate:!0}),{isAssistantEnabled:L,hideAssistantFloatingButton:R,chatMessages:o,unreadCount:ye,streaming:f,currentSessionId:T,lastUnread:O,isSessionEnded:I,isFloatingButtonShown:be,canManageAISettings:xe,onNodeExecution:Oe,trackUserOpenedAssistant:je,isNodeErrorActive:H,initErrorHelper:De,initSupportChat:X,sendMessage:ke,applyCodeDiff:Ne,undoCodeDiff:Pe,resetAssistantChat:B,addAssistantMessages:V,assistantThinkingMessage:A,chatSessionError:w,chatSessionTask:j,initCredHelp:Te,isCredTypeActive:Se,handleServiceError:K}});export{y as n,x as t};
//# sourceMappingURL=assistant.store-BGYzebcZ.js.map