(function(){try{var e=typeof window<`u`?window:typeof global<`u`?global:typeof globalThis<`u`?globalThis:typeof self<`u`?self:{};e.SENTRY_RELEASE={id:`n8n@2.9.4`}}catch{}})();try{(function(){var e=typeof window<`u`?window:typeof global<`u`?global:typeof globalThis<`u`?globalThis:typeof self<`u`?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]=`ee9ad255-edf4-4fa6-be68-919b7fd39781`,e._sentryDebugIdIdentifier=`sentry-dbid-ee9ad255-edf4-4fa6-be68-919b7fd39781`)})()}catch{}import{o as e}from"./chunk-Din3qlHY.js";import{C as t,Pt as n}from"./vue.runtime.esm-bundler-1e_FtHOF.js";import{M as r,yt as i}from"./_MapCache-DjbOQyB7.js";import{m as a}from"./src-CppJvwzX.js";import{It as o,Lt as s,Tt as c,Vt as l,_i as u,bi as d,fi as f,fn as p,hi as m,m as h,mi as g,oa as _,pi as v,pn as y,s as b,ui as x,ws as S,xr as C,yi as w,yr as T}from"./users.store-pCkD7Zo0.js";import{Gt as ee,Ht as E,N as D,Ri as O,Ut as k,Wt as A,ea as j,ho as M,oa as N,so as P,tr as F,zi as I}from"./constants-D1jZwsUK.js";import{j as L,m as R,r as z}from"./_baseOrderBy-El3qbNHQ.js";import{t as te}from"./executions.store-DnLtKXBA.js";import{t as ne}from"./useCanvasOperations-BHGWcL34.js";import{t as re}from"./retry-C_b9sBX6.js";import{t as ie}from"./pushConnection.store-IFO3HVvG.js";var B=e=>e.toString().split(`.`).concat([`0`,`0`]).slice(0,3).join(`.`),V=e=>!!e&&typeof e==`object`&&`type`in e&&`properties`in e&&!_(e.properties);const H=async(e,t)=>{let{nodeType:n,version:r,resource:i,operation:a}=t,o=B(r),s=await R({method:`GET`,baseURL:e,endpoint:`${[`schemas`,n.replace(`@n8n/`,``),o,i,a].filter(Boolean).join(`/`)}.json`,withCredentials:!1});if(!V(s))throw Error(`Invalid JSON schema`);return s};function U(e){return G(e)}function W(e){return[`string`,`number`,`boolean`].includes(e)}function G(e){if(e===null)return{type:`null`};let t=typeof e;return W(t)?{type:t}:Array.isArray(e)?K(e):e&&t===`object`?q(e):{type:`string`}}function K(e){return{type:`array`,items:e.length>0?G(e[0]):{}}}function q(e){let t={};return Object.entries(e).forEach(([e,n])=>{t[e]=G(n)}),{type:`object`,properties:t}}const J=L(`schemaPreview`,()=>{let e=n(new Map),t=z(),r=s(),i=b();function a({nodeType:e,version:t,operation:n,resource:r}){return`${e}_${t}_${r?.toString()??`all`}_${n?.toString()??`all`}`}async function o(n){let r=a(n),i=e.get(r);if(i)return i;try{let i=I(await H(t.baseUrl,n));return e.set(r,i),i}catch(t){let n=O(t);return e.set(r,n),n}}async function c(t){if(e.size===0||t.data.executionStatus!==`success`)return;let n=i.getNodeByName(t.nodeName);if(!n)return;let{id:o,type:s,typeVersion:c,parameters:{resource:l,operation:u}}=n,d=e.get(a({nodeType:s,version:c,resource:l,operation:u}));d?.ok&&r.track(`User executed node with schema preview`,{node_id:o,node_type:s,node_version:c,node_resource:l,node_operation:u,schema_preview:JSON.stringify(d.result),output_schema:JSON.stringify(U(t.data.data?.main?.[0]?.[0]?.json)),workflow_id:i.workflowId})}return{getSchemaPreview:o,trackSchemaPreviewExecution:c}});function Y(e,t,n,r,i){if(e instanceof m)return e.commands.some(n=>Y(n,t,e.commands,r,i));if(e instanceof v)return e.connectionData[1]?.node===t;if(e instanceof w){let[r,i]=e.connectionData;return i.node===t?n.some(e=>e instanceof d&&e.node.name===r.node):!1}let a=Object.values(r(t)).flat().flat().filter(e=>e!==null).map(e=>e.node);return e instanceof g?a.includes(e.node.name):e instanceof u?a.includes(e.nodeName)&&(e.newState||Object.keys(i(e.nodeName)).some(e=>e!==P.Main)):!1}function X(e,t,n){let r=t.indexOf(e);if(r>=0)return t.slice(r);let i=[...t,e];for(let[t,r]of Object.entries(n(e)))if(t===P.Main)for(let e of r)for(let{node:t}of e??[]){let e=X(t,i,n);if(e)return e}}function Z(){let e=f(),n=b();function r(e){return Object.entries(n.incomingConnectionsByNodeName(e)).filter(([e])=>e!==P.Main).flatMap(([,e])=>e.flat().filter(e=>e!==null))}function i(e,t){if((n.getParametersLastUpdate(e)??0)>t)return x.PARAMETERS_UPDATED;for(let n of r(e))if(i(n.node,t)!==void 0)return x.UPSTREAM_DIRTY}function a(t,i){for(let r=e.undoStack.length-1;r>=0;r--){let a=e.undoStack[r];if(a.getTimestamp()<i)break;if(Y(a,t,[],n.incomingConnectionsByNodeName,n.outgoingConnectionsByNodeName))return x.INCOMING_CONNECTIONS_UPDATED}for(let e of r(t))if(a(e.node,i)!==void 0)return x.UPSTREAM_DIRTY}let o=t(()=>{let e={};function t(r,i,a){if(a.has(r))return;let o=new Set(a);o.add(r);for(let[a,s]of Object.entries(n.outgoingConnectionsByNodeName(r)))if(a===P.Main)for(let n of s)for(let{node:r}of n??[])(!e[r]||e[r]>i)&&(e[r]=i),t(r,i+1,o)}for(let r of n.allNodes)Object.keys(n.incomingConnectionsByNodeName(r.name)).length>0||(e[r.name]=0,t(r.name,1,new Set));return e});return{dirtinessByName:t(()=>{let e={},t=n.getWorkflowRunData??{};function r(t,r){e[t]=e[t]??r;let i=X(t,[],n.incomingConnectionsByNodeName);if(!i)return;let a=[...i].sort((e,t)=>(o.value[e]??2**53-1)-(o.value[t]??2**53-1))?.[0];a&&o.value[a]&&(e[a]=e[a]??x.UPSTREAM_DIRTY)}for(let[e,o]of Object.entries(t)){let t=o[0]?.startTime??0;if(!t)continue;let s=i(e,t);if(s){r(e,s);continue}let c=a(e,t);if(c){r(e,c);continue}if(Object.values(n.incomingConnectionsByNodeName(e)).flat().flat().filter(e=>e!==null).some(e=>(n.getPinnedDataLastUpdate(e.node)??0)>t)){r(e,x.PINNED_DATA_UPDATED);continue}if((n.getPinnedDataLastRemovedAt(e)??0)>t){r(e,x.PINNED_DATA_UPDATED);continue}}return e})}}var ae=`N8N_AGENT_REQUESTS`;const Q=L(`agentRequest`,()=>{let e=r(ae,{}),t=(t,n)=>{e.value[t]||(e.value[t]={}),e.value[t][n]||(e.value[t][n]={query:{}})};return{agentRequests:e,getAgentRequests:(t,n)=>e.value[t]?.[n]?.query||{},getQueryValue:(t,n,r,i)=>{let a=e.value[t]?.[n]?.query?.[r];return typeof a==`string`||!i?a:a?.[i]},setAgentRequestForNode:(n,r,i)=>{t(n,r),e.value[n][r]={...i,query:{...i.query}}},clearAgentRequests:(t,n)=>{e.value[t]&&(e.value[t][n]={query:{}})},clearAllAgentRequests:t=>{t?e.value[t]={}:e.value={}},getAgentRequest:(t,n)=>{if(e.value[t])return e.value[t]?.[n]}}});var $=e(a(),1);function oe(e){let n=c(),r=i(),a=T(),u=s(),d=C(),f=S(),m=Q(),g=z(),v=ie(),x=b(),w=e.workflowState??l(),E=o({workflowState:w}),O=y({router:e.router,workflowState:w}),k=te(),{dirtinessByName:A}=Z(),{startChat:M}=ne(),F=t(()=>x.workflowObject);function I(e){return[...e].sort((e,t)=>{let n=x.getNodeByName(e)?.position??[0,0],r=x.getNodeByName(t)?.position??[0,0],i=n[1],a=r[1];return i===a?0:i>a?1:-1})}async function L(e){if(!v.isConnected)throw Error(r.baseText(`workflowRun.noActiveConnectionToTheServer`));w.setActiveExecutionId(null);let t;try{t=await x.runWorkflow(e)}catch(e){throw w.setActiveExecutionId(void 0),e}let n=x.previousExecutionId!==t.executionId,i=x.activeExecutionId===null;return t.executionId&&n&&i&&w.setActiveExecutionId(t.executionId),t.waitingForWebhook===!0&&(x.executionWaitingForWebhook=!0),t}async function R(e){if(!x.activeExecutionId){a.clearAllStickyNotifications();try{let t=[];e.destinationNode!==void 0&&(t=F.value.getParentNodes(e.destinationNode.nodeName,P.Main,-1));let i=x.getWorkflowRunData;x.isWorkflowSaved[x.workflowId]||await O.saveCurrentWorkflow();let o=await n.getWorkflowDataToSave();if(g.binaryDataMode===`default`&&o.settings?.binaryMode===`combined`){a.showMessage({title:r.baseText(`workflowRun.showError.unsupportedExecutionLogic.title`),message:r.baseText(`workflowRun.showError.unsupportedExecutionLogic.description`),type:`error`});return}let{startNodeNames:s}=B(t,i,o.pinData,F.value),c=e.destinationNode?x.getNodeByName(e.destinationNode.nodeName)?.type:``,l,u;if(s.length===0&&t.length===0&&`destinationNode`in e&&e.destinationNode!==void 0?(l=e.destinationNode.nodeName,s.push(e.destinationNode.nodeName)):e.triggerNode&&e.nodeData&&!e.rerunTriggerNode?s.push(...F.value.getChildNodes(e.triggerNode,P.Main,1)):e.destinationNode&&(l=e.destinationNode.nodeName),e.triggerNode&&(u={name:e.triggerNode,data:e.nodeData}),e.destinationNode&&(x.checkIfNodeHasChatParent(e.destinationNode.nodeName)||c===`@n8n/n8n-nodes-langchain.chatTrigger`)&&e.source!==`RunData.ManualChatMessage`){let t=F.value.getStartNode(e.destinationNode.nodeName);if(t&&t.type===`@n8n/n8n-nodes-langchain.chatTrigger`){let n=E.getNodeInputData(t,0,0,`input`)?.length>0,r=!!o.pinData?.[t.name];if(!n&&!r){x.chatPartialExecutionDestinationNode=e.destinationNode.nodeName,M();return}}}let f=o.nodes.filter(e=>!e.disabled&&e.type.toLowerCase().includes(`trigger`)),_=f.find(e=>e.type===ee),v=_?.parameters?.options;e.triggerNode===_?.name&&v?.responseMode===`responseNodes`&&(o.nodes.filter(e=>!e.disabled&&(e.type===`@n8n/n8n-nodes-langchain.chat`||e.type===`@n8n/n8n-nodes-langchain.chatTool`||e.type===`@n8n/n8n-nodes-langchain.chatHitlTool`||e.type===`n8n-nodes-base.respondToWebhook`))?.length||a.showMessage({title:r.baseText(`workflowRun.showWarning.noChatResponseNodes.title`),message:r.baseText(`workflowRun.showWarning.noChatResponseNodes.description`),type:`warning`})),!e.destinationNode&&e.source!==`RunData.ManualChatMessage`&&_&&f.filter(e=>e.type!==`@n8n/n8n-nodes-langchain.chatTrigger`).length&&(_.disabled=!0);let y=e.destinationNode!==void 0,b=I(s).map(e=>{let t=(0,$.default)(i,[e,0,`source`,0],null);if(t===null){let r=F.value.getParentNodes(e,P.Main,1);t=(0,$.default)(n.executeData(F.value.connectionsBySourceNode,r,e,P.Main,0),[`source`,P.Main,0],null)}return{name:e,sourceData:t}}).filter(t=>e.destinationNode&&x.checkIfNodeHasChatParent(e.destinationNode.nodeName)?t.name!==e.destinationNode.nodeName:!0),S={workflowData:o,runData:y?i??void 0:void 0,startNodes:b,triggerToStartFrom:u};if(`destinationNode`in e){S.destinationNode=e.destinationNode;let t=x.getNodeByName(e.destinationNode?.nodeName??``)?.id;if(F.value.id&&t){let e=m.getAgentRequest(F.value.id,t);e&&(S.agentRequest={query:e.query??{},tool:{name:e.toolName??``}})}}if(S.runData){let e=Object.entries(A.value).flatMap(([e,t])=>t?[e]:[]);S.dirtyNodeNames=e.length>0?e:void 0}let C={id:D,finished:!1,mode:`manual`,status:`running`,createdAt:new Date,startedAt:new Date,stoppedAt:void 0,workflowId:F.value.id,executedNode:l,triggerNode:u?.name,data:j({resultData:{runData:S.runData??{},pinData:o.pinData}}),workflowData:{id:x.workflowId,name:o.name,active:o.active,createdAt:0,updatedAt:0,...o}};w.setWorkflowExecutionData(C),E.updateNodesExecutionIssues(),p().setDocumentTitle(F.value.name,`EXECUTING`);let T=await L(S),k=o.pinData??{},N=(()=>e=>{let t=e.parameters.path||e.parameters.options?.path||e.webhookId;return`${g.formTestUrl}/${t}`})();try{await h({nodes:o.nodes,runData:x.getWorkflowExecution?.data?.resultData?.runData,destinationNode:e.destinationNode?.nodeName,triggerNode:e.triggerNode,pinData:k,directParentNodes:t,source:e.source,getTestUrl:N})}catch{}return await d.run(`workflowRun.runWorkflow`,{nodeName:e.destinationNode?.nodeName,source:e.source}),T}catch(e){console.error(e),w.setWorkflowExecutionData(null),p().setDocumentTitle(F.value.name,`ERROR`),a.showError(e,r.baseText(`workflowRun.showError.title`));return}}}function B(e,t,n,r){let i=new Set,a;if(t!==null&&Object.keys(t).length!==0){a={};for(let o of e){let e=r.getParentNodes(o,P.Main);if(!r.nodes[o].disabled){e.push(o);for(let r of e){if(!t[r]?.length&&!n?.[r]?.length||t[r]?.[0]?.error!==void 0){i.add(r);break}t[r]&&!t[r]?.[0]?.error&&(a[r]=t[r]?.slice(0,1))}}}_(a)&&(a=void 0)}return{runData:a,startNodeNames:[...i]}}async function V(){let e=x.activeExecutionId,t;if(e)try{t=await k.stopCurrentExecution(e)}catch(t){let n=await x.getExecution(e);if(n===void 0)a.showMessage({title:r.baseText(`nodeView.showMessage.stopExecutionCatch.unsaved.title`),message:r.baseText(`nodeView.showMessage.stopExecutionCatch.unsaved.message`),type:`success`});else if(n?.finished){let e={data:n.data,workflowData:x.workflow,finished:n.finished,mode:n.mode,startedAt:n.startedAt,stoppedAt:n.stoppedAt};w.setWorkflowExecutionData(e),a.showMessage({title:r.baseText(`nodeView.showMessage.stopExecutionCatch.title`),message:r.baseText(`nodeView.showMessage.stopExecutionCatch.message`),type:`success`})}else a.showError(t,r.baseText(`nodeView.showError.stopExecution.title`))}finally{await re(async()=>{let n=await x.getExecution(e);return[`running`,`waiting`].includes(n?.status)?!1:(w.markExecutionAsStopped(t),!0)},250,20)||w.markExecutionAsStopped(t)}}async function H(){try{await x.removeTestWebhook(x.workflowId)}catch(e){a.showError(e,r.baseText(`nodeView.showError.stopWaitingForWebhook.title`));return}}async function U(e,t){n.getWorkflowDataToSave().then(t=>{let r={workflow_id:F.value.id,node_graph_string:JSON.stringify(N(t,n.getNodeTypes(),{isCloudDeployment:f.isCloudDeployment}).nodeGraph),button_type:e};u.track(`User clicked execute workflow button`,r),d.run(`nodeView.onRunWorkflow`,r)});let r=t??x.selectedTriggerNodeName;if(!r){let e=Object.values(F.value.nodes).filter(e=>!e.disabled&&e.type.toLowerCase().includes(`trigger`));e.length===1&&(r=e[0].name)}R({triggerNode:r})}return{consolidateRunDataAndStartNodes:B,runEntireWorkflow:U,runWorkflow:R,runWorkflowApi:L,stopCurrentExecution:V,stopWaitingForWebhook:H,sortNodesByYPosition:I}}export{J as i,Q as n,Z as r,oe as t};
//# sourceMappingURL=useRunWorkflow-DzzlHC01.js.map