(function(){try{var e=typeof window<`u`?window:typeof global<`u`?global:typeof globalThis<`u`?globalThis:typeof self<`u`?self:{};e.SENTRY_RELEASE={id:`n8n@2.9.4`}}catch{}})();try{(function(){var e=typeof window<`u`?window:typeof global<`u`?global:typeof globalThis<`u`?globalThis:typeof self<`u`?self:{},t=new e.Error().stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]=`ddc178db-f424-4b43-9a5e-bb97ce73d134`,e._sentryDebugIdIdentifier=`sentry-dbid-ddc178db-f424-4b43-9a5e-bb97ce73d134`)})()}catch{}import{C as e,It as t}from"./vue.runtime.esm-bundler-1e_FtHOF.js";import{yt as n}from"./_MapCache-DjbOQyB7.js";import{Ci as r}from"./src-CppJvwzX.js";import{Ca as i,Rr as a,Sr as o,Wc as s,r as c,s as l,t as u,un as d}from"./users.store-pCkD7Zo0.js";import{al as f,rs as p}from"./constants-D1jZwsUK.js";import{j as m,r as h}from"./_baseOrderBy-El3qbNHQ.js";import{t as g}from"./pushConnection.store-IFO3HVvG.js";function _({route:r}){let i=c(),a=o(),s=n(),l=t(null),u=e(()=>r.name===p.DEMO),d=[];function f(e){if(!(u.value||window.preventNodeViewBeforeUnload)){if(d.forEach(e=>e()),i.stateIsDirty)return e.returnValue=!0,!0;a.startLoading(s.baseText(`nodeView.redirecting`))}}function m(e){d.push(e)}function h(){window.addEventListener(`beforeunload`,f)}function g(){l.value&&clearTimeout(l.value),window.removeEventListener(`beforeunload`,f)}return{onBeforeUnload:f,addBeforeUnloadEventBindings:h,removeBeforeUnloadEventBindings:g,addBeforeUnloadHandler:m}}var ee=5*f.MINUTE,v=30*f.SECOND,y=20*f.SECOND,b=5*f.SECOND,x=20*f.SECOND;const S=m(s.COLLABORATION,()=>{let n=g(),o=l(),s=a(),p=u(),m=c(),S=h(),te=d(),{addBeforeUnloadEventBindings:C,removeBeforeUnloadEventBindings:ne,addBeforeUnloadHandler:re}=_({route:r()}),w=t(null),T=t([]),E=t(null),D=t(Date.now()),O=t(null),k=t(null),A=t(null),j=t(null),M=t(null),N=t(null),P=null,F=e(()=>E.value===p.currentUserId),I=e(()=>E.value?T.value.find(e=>e.user.id===E.value):null),L=e(()=>E.value!==null),R=e(()=>L.value&&!F.value);async function z(){try{let{workflowId:e}=o;return o.isWorkflowSaved[e]?(await i(S.restApiContext,e)).userId:null}catch{return null}}function B(){N.value&&n.send({type:`workflowOpened`,workflowId:N.value})}function V(){N.value&&(n.send({type:`workflowClosed`,workflowId:N.value}),T.value=T.value.filter(({user:e})=>e.id!==p.currentUserId))}let H=()=>{k.value!==null&&(clearInterval(k.value),k.value=null)},U=()=>{H(),k.value=window.setInterval(B,ee)},W=()=>{A.value!==null&&(clearInterval(A.value),A.value=null)},G=()=>{if(!F.value||!N.value){W();return}n.send({type:`writeAccessHeartbeat`,workflowId:N.value})},K=()=>{W(),A.value=window.setInterval(G,v)},q=()=>{j.value!==null&&(clearInterval(j.value),j.value=null)},J=async()=>{if(!R.value){q();return}!await z()&&E.value&&(E.value=null,q())},Y=()=>{q(),j.value=window.setInterval(J,y)};re(()=>{V(),m.stateIsDirty&&(w.value=setTimeout(()=>B,5*f.SECOND))});function X(){D.value=Date.now()}function Z(){if(F.value)return!0;if(!N.value)return!1;try{n.send({type:`writeAccessRequested`,workflowId:N.value})}catch{return!1}return!0}function Q(){if(E.value=null,W(),!N.value)return!0;try{return n.send({type:`writeAccessReleaseRequested`,workflowId:N.value}),!0}catch{return!1}}function ie(){F.value&&(te.streaming||Date.now()-D.value>=x&&Q())}function $(){O.value!==null&&(clearInterval(O.value),O.value=null)}function ae(){$(),O.value=window.setInterval(ie,b)}function oe(e){P=e}async function se(){if(!(F.value||!N.value))try{let e=await s.fetchWorkflow(N.value);return P&&P(e),!0}catch(e){return console.error(`[Collaboration] Error in handleWorkflowUpdate:`,e),!1}}function ce(){E.value&&(T.value.some(e=>e.user.id===E.value)||(E.value=null))}async function le(){if(M.value)return;N.value=o.workflowId;let e=await z();e&&(E.value=e,F.value?K():Y()),M.value=n.addEventListener(e=>{if(e.type===`collaboratorsChanged`&&e.data.workflowId===N.value){T.value=e.data.collaborators,ce();return}if(e.type===`writeAccessAcquired`&&e.data.workflowId===N.value){E.value=e.data.userId,F.value?(X(),K(),q()):Y();return}if(e.type===`writeAccessReleased`&&e.data.workflowId===N.value){E.value=null,W(),q();return}if(e.type===`workflowUpdated`&&e.data.workflowId===N.value){se();return}}),C(),B(),U(),ae()}function ue(){typeof M.value==`function`&&(M.value(),M.value=null),V(),H(),W(),q(),$(),F.value&&Q(),n.clearQueue(),ne(),w.value&&clearTimeout(w.value),N.value=null,E.value=null,T.value=[]}return{collaborators:T,currentWriter:I,isCurrentUserWriter:F,isAnyoneWriting:L,shouldBeReadOnly:R,requestWriteAccess:Z,releaseWriteAccess:Q,recordActivity:X,initialize:le,terminate:ue,startHeartbeat:U,stopHeartbeat:H,setRefreshCanvasCallback:oe}});export{_ as n,S as t};
//# sourceMappingURL=collaboration.store-QKYwE2H2.js.map