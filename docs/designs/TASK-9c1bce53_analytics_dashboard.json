{
  "schema_sql": "-- 1. Table for Daily KPI Snapshots (Historical Persistence)\nCREATE TABLE IF NOT EXISTS public.analytics_daily_snapshots (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    date DATE NOT NULL UNIQUE,\n    total_revenue NUMERIC(12, 2) DEFAULT 0,\n    active_students INT DEFAULT 0,\n    new_signups INT DEFAULT 0,\n    retention_rate NUMERIC(5, 2),\n    fleet_utilization NUMERIC(5, 2),\n    raw_data JSONB DEFAULT '{}', -- Store extra breakdown data\n    created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- 2. View: Unified Financial Stream (Rentals + Inscriptions)\nCREATE OR REPLACE VIEW public.analytics_financial_stream_view AS\nSELECT \n    'rental' as source_type,\n    id as source_id,\n    fecha_pago as transaction_date,\n    monto_total as amount,\n    estado_pago as status\nFROM public.reservas_alquiler\nWHERE estado_pago = 'pagado'\nUNION ALL\nSELECT \n    'inscription' as source_type,\n    id as source_id,\n    created_at as transaction_date,\n    monto_total as amount,\n    estado_pago as status\nFROM public.inscripciones\nWHERE estado_pago = 'pagado';\n\n-- 3. RLS Policies\nALTER TABLE public.analytics_daily_snapshots ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Admins read analytics\" ON public.analytics_daily_snapshots\n    FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.rol = 'admin'\n        )\n    );\n",
  "openapi_yaml": "openapi: 3.0.0\ninfo:\n  title: Admin Analytics API\n  version: 1.0.0\npaths:\n  /api/admin/analytics/dashboard:\n    get:\n      summary: Get consolidated dashboard metrics\n      security:\n        - cookieAuth: []\n      parameters:\n        - in: query\n          name: startDate\n          schema:\n            type: string\n            format: date\n        - in: query\n          name: endDate\n          schema:\n            type: string\n            format: date\n      responses:\n        '200':\n          description: Successful response\n          content:\n            application/json:\n              schema:\n                type: object\n                properties:\n                  kpis:\n                    type: object\n                    properties:\n                      revenue: { type: number }\n                      activeUsers: { type: integer }\n                      retention: { type: number }\n                  charts:\n                    type: object\n                    properties:\n                      revenueTrend: { type: array, items: { type: object } }\n                      userGrowth: { type: array, items: { type: object } }\n",
  "dependencies": ["recharts", "date-fns", "jspdf", "jspdf-autotable", "lucide-react"],
  "vote": "OK",
  "vote_reason": "The design moves expensive aggregation logic from the Node.js runtime to the Database layer using Views and Snapshot tables. This ensures scalability as the dataset grows. The schema supports historical trend analysis without re-processing all raw records every request.",
  "confidence": 98,
  "architectural_notes": "CRITICAL: The `analytics_daily_snapshots` table should be populated via a nightly Cron Job (e.g., Supabase pg_cron or a scheduled Edge Function). For real-time data (today), the API should query the live Views and merge with the historical Snapshots. The frontend should continue using Recharts for visualization."
}