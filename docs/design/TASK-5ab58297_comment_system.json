{
  "schema_sql": "CREATE TABLE IF NOT EXISTS public.comments (\n    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    resource_type TEXT NOT NULL,\n    resource_id UUID NOT NULL,\n    content TEXT NOT NULL CHECK (char_length(content) > 0),\n    parent_id UUID REFERENCES public.comments(id) ON DELETE CASCADE,\n    is_edited BOOLEAN DEFAULT false,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\nCREATE INDEX IF NOT EXISTS idx_comments_resource ON public.comments(resource_type, resource_id);\nCREATE INDEX IF NOT EXISTS idx_comments_user ON public.comments(user_id);\n\nALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Public read comments\" ON public.comments FOR SELECT USING (true);\nCREATE POLICY \"Users can create comments\" ON public.comments FOR INSERT WITH CHECK (auth.uid() = user_id);\nCREATE POLICY \"Users can update own comments\" ON public.comments FOR UPDATE USING (auth.uid() = user_id);\nCREATE POLICY \"Users can delete own comments\" ON public.comments FOR DELETE USING (auth.uid() = user_id);\n\n-- Trigger for updating updated_at\nCREATE OR REPLACE FUNCTION public.handle_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    NEW.is_edited = TRUE;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER set_updated_at_comments\n    BEFORE UPDATE ON public.comments\n    FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();",
  "openapi_yaml": "openapi: 3.0.0\ninfo:\n  title: Comments API\n  version: 1.0.0\npaths:\n  /comments:\n    get:\n      summary: Get comments for a resource\n      parameters:\n        - name: resource_type\n          in: query\n          required: true\n          schema:\n            type: string\n        - name: resource_id\n          in: query\n          required: true\n          schema:\n            type: string\n            format: uuid\n      responses:\n        '200':\n          description: List of comments\n    post:\n      summary: Create a new comment\n      requestBody:\n        required: true\n        content:\n          application/json:\n            schema:\n              type: object\n              properties:\n                resource_type:\n                  type: string\n                resource_id:\n                  type: string\n                  format: uuid\n                content:\n                  type: string\n                parent_id:\n                  type: string\n                  format: uuid\n                  nullable: true\n      responses:\n        '201':\n          description: Comment created\n  /comments/{id}:\n    patch:\n      summary: Update a comment\n      parameters:\n        - name: id\n          in: path\n          required: true\n          schema:\n            type: string\n            format: uuid\n      requestBody:\n        required: true\n        content:\n          application/json:\n            schema:\n              type: object\n              properties:\n                content:\n                  type: string\n      responses:\n        '200':\n          description: Comment updated\n    delete:\n      summary: Delete a comment\n      parameters:\n        - name: id\n          in: path\n          required: true\n          schema:\n            type: string\n            format: uuid\n      responses:\n        '204':\n          description: Comment deleted",
  "dependencies": [],
  "vote": "OK",
  "vote_reason": "Design establishes a robust, polymorphic comment system. The codebase analysis did not reveal an existing 'comments' table, implying the 'duplicated column' issue might be in the live DB or a misunderstanding. This schema ensures a clean state.",
  "confidence": 95,
  "architectural_notes": "The requested 'comments' table was not found in the codebase migrations. If it exists in the live database with a duplicated column, the implementation phase must involve a migration to align it with this normalized schema, likely involving `ALTER TABLE ... DROP COLUMN ...` to remove the duplicate."
}